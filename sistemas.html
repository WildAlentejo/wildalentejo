<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistemas & Gr치ficos | Wild Alentejo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #2D4C2F; --secondary: #8DAF57; --bg: #f4f1ea; --card-bg: #fdfdfa; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #333; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* Grid de Dados */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 30px; }
        .data-item { background: var(--card-bg); padding: 15px; border-radius: 4px; text-align: center; border-bottom: 3px solid var(--secondary); }
        .data-value { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: block; }
        .data-unit { font-size: 0.8rem; color: #666; }

        /* Sec칞칚o de Gr치ficos */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
        .chart-card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-card h3 { font-size: 0.9rem; text-transform: uppercase; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        canvas { width: 100% !important; height: 250px !important; }

        @media (max-width: 600px) { .charts-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h2>游늵 Monitoriza칞칚o em Tempo Real</h2>
    <p style="font-size: 0.8rem;">칔ltima atualiza칞칚o: <strong id="last_updated">--</strong></p>

    <div class="data-grid">
        <div class="data-item"><h3>Casa</h3><span id="v_casa_t">--</span>춿C / <span id="v_casa_h">--</span>%</div>
        <div class="data-item"><h3>Quarto</h3><span id="v_quarto_t">--</span>춿C / <span id="v_quarto_h">--</span>%</div>
        <div class="data-item"><h3>Estufa (Ar)</h3><span id="v_estufa_t">--</span>춿C / <span id="v_estufa_h">--</span>%</div>
        <div class="data-item"><h3>Estufa (Solo)</h3><span id="v_solo_t">--</span>춿C / <span id="v_solo_h">--</span>%</div>
    </div>

    <div class="charts-container">
        <div class="chart-card"><h3>游늳 Hist칩rico Casa</h3><canvas id="chartCasa"></canvas></div>
        <div class="chart-card"><h3>游늳 Hist칩rico Quarto</h3><canvas id="chartQuarto"></canvas></div>
        <div class="chart-card"><h3>游늳 Hist칩rico Estufa (Ar)</h3><canvas id="chartEstufa"></canvas></div>
        <div class="chart-card"><h3>游늳 Hist칩rico Estufa (Solo)</h3><canvas id="chartSolo"></canvas></div>
    </div>
</div>

<script>
    const GIST_URL = "https://gist.githubusercontent.com/WildAlentejo/8e8d20f8c8534c53c8827a59e563884e/raw/wild-alentejo-sensors.json";
    const MAX_POINTS = 20; // N칰mero de pontos a mostrar no gr치fico

    // Configura칞칚o Base dos Gr치ficos
    function createChartConfig(labelT, labelH) {
        return {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Temp 춿C', data: [], borderColor: '#cc4400', backgroundColor: '#cc4400', yAxisID: 'yT', tension: 0.3 },
                { label: 'Hum %', data: [], borderColor: '#3498db', backgroundColor: '#3498db', yAxisID: 'yH', tension: 0.3 }
            ]},
            options: {
                responsive: true,
                scales: {
                    yT: { type: 'linear', position: 'left', title: { display: true, text: 'Temp (춿C)' } },
                    yH: { type: 'linear', position: 'right', title: { display: true, text: 'Hum (%)' }, grid: { drawOnChartArea: false } }
                }
            }
        };
    }

    // Inicializar Gr치ficos
    const charts = {
        casa: new Chart(document.getElementById('chartCasa'), createChartConfig()),
        quarto: new Chart(document.getElementById('chartQuarto'), createChartConfig()),
        estufa: new Chart(document.getElementById('chartEstufa'), createChartConfig()),
        solo: new Chart(document.getElementById('chartSolo'), createChartConfig())
    };

    function updateChart(chart, label, temp, hum) {
        if (chart.data.labels.length >= MAX_POINTS) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }
        chart.data.labels.push(label);
        chart.data.datasets[0].data.push(temp);
        chart.data.datasets[1].data.push(hum);
        chart.update();
    }

    async function fetchData() {
        try {
            const res = await fetch(`${GIST_URL}?t=${Date.now()}`, { cache: "no-store" });
            const data = await res.json();
            const time = new Date().toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });

            // Atualizar Valores Texto
            document.getElementById('v_casa_t').innerText = data.casa_temp; document.getElementById('v_casa_h').innerText = data.casa_hum;
            document.getElementById('v_quarto_t').innerText = data.quarto_temp; document.getElementById('v_quarto_h').innerText = data.quarto_hum;
            document.getElementById('v_estufa_t').innerText = data.estufa_dht_temp; document.getElementById('v_estufa_h').innerText = data.estufa_dht_hum;
            document.getElementById('v_solo_t').innerText = data.greenhouse_temp_c; document.getElementById('v_solo_h').innerText = data.greenhouse_hum;
            document.getElementById('last_updated').innerText = data.last_updated;

            // Atualizar Gr치ficos
            updateChart(charts.casa, time, data.casa_temp, data.casa_hum);
            updateChart(charts.quarto, time, data.quarto_temp, data.quarto_hum);
            updateChart(charts.estufa, time, data.estufa_dht_temp, data.estufa_dht_hum);
            updateChart(charts.solo, time, data.greenhouse_temp_c, data.greenhouse_hum);

        } catch (e) { console.error("Erro nos sensores:", e); }
    }

    fetchData();
    setInterval(fetchData, 300000); // 5 em 5 minutos
</script>

</body>
</html>
