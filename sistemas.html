<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Sistema | Wild Alentejo</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <style>
        :root { --primary: #2D4C2F; --secondary: #8DAF57; --bg: #f4f1ea; --card-bg: #fdfdfa; }
        body { font-family: 'Inter', sans-serif; color: #333; margin: 0; background-color: var(--bg); background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        header { background: url('img/pattern-alentejo.png'), rgba(45, 76, 47, 0.98); background-repeat: repeat; background-size: 320px; background-blend-mode: overlay; padding: 8px 0; border-bottom: 2px solid var(--secondary); position: sticky; top: 0; z-index: 1000; }
        header .container { display: flex; justify-content: flex-start; align-items: center; gap: 80px; }
        .logo img { height: 70px; border-radius: 8px; }
        nav { display: flex; gap: 20px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; }
        nav a { text-decoration: none; color: rgba(255,255,255,0.7); transition: 0.3s; }
        nav a:hover, nav a.active { color: #fff; border-bottom: 2px solid var(--secondary); padding-bottom: 3px; }

        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0 40px; }
        .data-item { background: var(--card-bg); padding: 20px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.05); text-align: center; border-bottom: 3px solid var(--secondary); }
        .data-item h3 { font-size: 0.65rem; text-transform: uppercase; color: #888; margin: 0 0 10px; }
        .data-value { font-size: 1.6rem; font-weight: 800; color: var(--primary); display: block; }

        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
        .chart-card { background: var(--card-bg); padding: 10px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .chart-card h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--primary); padding: 10px; margin: 0; border-bottom: 1px solid #eee; }
        .plot-div { width: 100%; height: 300px; }

        #loader { text-align: center; padding: 100px; font-weight: bold; color: var(--primary); }
        footer { background: url('img/pattern-alentejo.png'), var(--primary); background-blend-mode: overlay; color: white; padding: 40px 0; text-align: center; margin-top: 60px; border-top: 3px solid var(--secondary); }
        @media (max-width: 768px) { header .container { gap: 20px; flex-direction: column; } }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="logo"><a href="index.html"><img src="img/logo.png" alt="Wild Alentejo"></a></div>
            <nav>
                <a href="index.html">InÃ­cio</a>
                <a href="sistema.html" class="active">O Sistema</a>
                <a href="logbook.html">Logbook</a>
                <a href="adote.html">Adote-me</a>
                <a href="galeria.html">Galeria</a>
                <a href="loja.html">Loja</a>
                <a href="sobre.html">Contacto</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="loader">ğŸšœ Sincronizando com MÃ©rtola...</div>

        <div id="main-content" style="display:none; padding: 40px 0;">
            <h2>ğŸ“Š Estado Atual</h2>
            <div class="data-grid">
                <div class="data-item"><h3>âš¡ Bateria</h3><span id="v_batt">--</span> V</div>
                <div class="data-item"><h3>ğŸ’§ PoÃ§o</h3><span id="v_well">--</span> %</div>
                <div class="data-item"><h3>ğŸ  Casa</h3><span id="v_casa">--</span> Â°C</div>
                <div class="data-item"><h3>ğŸŒ± Estufa Solo</h3><span id="v_solo">--</span> Â°C</div>
            </div>

            <h2>ğŸ“ˆ HistÃ³rico 24h</h2>
            <div class="charts-container">
                <div class="chart-card"><h3>âš¡ TensÃ£o Bateria (V)</h3><div id="graphBatt" class="plot-div"></div></div>
                <div class="chart-card"><h3>ğŸ’§ NÃ­vel do PoÃ§o (%)</h3><div id="graphWell" class="plot-div"></div></div>
                <div class="chart-card"><h3>ğŸ  Casa (T+H)</h3><div id="graphCasa" class="plot-div"></div></div>
                <div class="chart-card"><h3>ğŸ›Œ Quarto (T+H)</h3><div id="graphQuarto" class="plot-div"></div></div>
                <div class="chart-card"><h3>ğŸŒ¬ï¸ Estufa Ar (T+H)</h3><div id="graphEstufa" class="plot-div"></div></div>
                <div class="chart-card"><h3>ğŸŒ± Estufa Solo (T+H)</h3><div id="graphSolo" class="plot-div"></div></div>
            </div>
        </div>
    </main>

    <footer><div class="container"><p>Wild Alentejo &copy; 2026</p></div></footer>

    <script>
        const GIST_ID = "8e8d20f8c8534c53c8827a59e563884e";
        
        async function loadData() {
            try {
                const resCommits = await fetch(`https://api.github.com/gists/${GIST_ID}/commits`);
                const commits = await resCommits.json();
                const lastCommits = commits.slice(0, 20).reverse();
                
                let history = [];
                for (const c of lastCommits) {
                    const r = await fetch(`https://gist.githubusercontent.com/WildAlentejo/${GIST_ID}/raw/${c.version}/wild-alentejo-sensors.json`);
                    if (r.ok) history.push(await r.json());
                }

                const times = history.map(d => d.last_updated);
                
                const layout = (y1Name, y2Name = null) => ({
                    margin: { l: 50, r: 50, t: 30, b: 50 },
                    showlegend: true, legend: { orientation: 'h', x: 0, y: -0.2 },
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    yaxis: { title: y1Name, titlefont: {color: '#cc4400'}, tickfont: {color: '#cc4400'}, gridcolor: '#eee' },
                    yaxis2: y2Name ? { title: y2Name, titlefont: {color: '#3498db'}, tickfont: {color: '#3498db'}, overlaying: 'y', side: 'right', showgrid: false } : null
                });

                const line = (y, name, color, yaxis = 'y') => ({ x: times, y: y, name: name, type: 'scatter', mode: 'lines+markers', line: {color: color, width: 2, shape: 'spline'}, yaxis: yaxis });

                // BATERIA E POÃ‡O (Simples)
                Plotly.newPlot('graphBatt', [line(history.map(d=>d.battery_voltage), 'Voltagem', '#2D4C2F')], layout('Volts'));
                Plotly.newPlot('graphWell', [line(history.map(d=>d.well_water_level), 'NÃ­vel', '#3498db')], layout('% NÃ­vel'));

                // SENSORES DUPLOS (T + H)
                const renderDouble = (id, tArr, hArr) => Plotly.newPlot(id, [line(tArr, 'Temp Â°C', '#cc4400'), line(hArr, 'Hum %', '#3498db', 'y2')], layout('Â°C', '%'));

                renderDouble('graphCasa', history.map(d=>d.casa_temp), history.map(d=>d.casa_hum));
                renderDouble('graphQuarto', history.map(d=>d.quarto_temp), history.map(d=>d.quarto_hum));
                renderDouble('graphEstufa', history.map(d=>d.estufa_dht_temp), history.map(d=>d.estufa_dht_hum));
                renderDouble('graphSolo', history.map(d=>d.greenhouse_temp_c), history.map(d=>d.greenhouse_hum));

                // Texto atual
                const cur = history[history.length-1];
                document.getElementById('v_batt').innerText = cur.battery_voltage.toFixed(1);
                document.getElementById('v_well').innerText = cur.well_water_level.toFixed(0);
                document.getElementById('v_casa').innerText = cur.casa_temp.toFixed(1);
                document.getElementById('v_solo').innerText = cur.greenhouse_temp_c.toFixed(1);

                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } catch (e) { document.getElementById('loader').innerText = "Erro na ligaÃ§Ã£o."; }
        }
        loadData();
    </script>
</body>
</html>
